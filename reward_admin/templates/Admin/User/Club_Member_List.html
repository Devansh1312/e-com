{% extends 'base.html' %}
{% load static %}
{% load sass_tags %}
{% load permission_tags %}
{% block css %}
<!-- Plugins css start-->
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/datatables.scss' %}">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<style>
    /* Add this to your existing CSS in the style section */

/* Error container styling */
#errorContainer {
    max-height: 400px;
    overflow-y: auto;
}

#errorContainer .error-list {
    border: 1px solid #f8d7da;
    border-radius: 4px;
    background-color: #f8f9fa;
    padding: 10px;
}

#errorContainer .error-list::-webkit-scrollbar {
    width: 8px;
}

#errorContainer .error-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

#errorContainer .error-list::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

#errorContainer .error-list::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* Modal size adjustment */
#uploadExcelModal .modal-lg {
    max-width: 800px;
}

/* Better spacing for error items */
#errorContainer .border {
    transition: all 0.3s ease;
}

#errorContainer .border:hover {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Success message styling */
#errorContainer .alert-success {
    border-color: #d4edda;
    background-color: #d4edda;
    color: #155724;
}

/* Warning message styling */
#errorContainer .alert-warning {
    border-color: #ffeaa7;
    background-color: #ffeaa7;
    color: #856404;
}

/* Info message styling */
#errorContainer .alert-info {
    border-color: #bee5eb;
    background-color: #d1ecf1;
    color: #0c5460;
}
    .dataTables_wrapper .dataTables_paginate .paginate_button {
        padding: 0.25rem 0.5rem;
        margin-left: 0;
        border: 1px solid transparent;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        background: #7366ff;
        color: white !important;
        border: 1px solid #7366ff;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
    }
    .dataTables_wrapper .dataTables_filter input {
        margin-left: 0.5em;
        border-radius: 4px;
        border: 1px solid #ced4da;
        padding: 0.375rem 0.75rem;
    }
    .dataTables_wrapper .dataTables_length select {
        border-radius: 4px;
        border: 1px solid #ced4da;
        padding: 0.375rem 1.75rem 0.375rem 0.75rem;
    }
    .dataTables_wrapper .dataTables_info {
        padding-top: 0.5em;
    }
    /* Modal styles */
    .modal {
        backdrop-filter: blur(5px);
    }
    .modal-backdrop {
        background-color: rgba(0,0,0,0.4);
    }
    .modal-dialog {
        pointer-events: all;
    }
    .is-invalid {
        border-color: #dc3545;
    }
    .invalid-feedback {
        display: none;
        color: #dc3545;
        font-size: 0.875em;
    }
    .is-invalid ~ .invalid-feedback {
        display: block;
    }
    .form-control.is-invalid, .form-control.is-invalid:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220,53,69,.25);
    }
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 9999;
        display: none;
        justify-content: center;
        align-items: center;
    }
    .loading-spinner {
        color: white;
        font-size: 3rem;
    }
    
    /* Toast styles */
    .toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 10000;
    }
    
    .custom-toast {
        min-width: 300px;
        margin-bottom: 10px;
    }
    
    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    @media (max-width: 767px) {
        .page-title .btn {
            width: 100%;
        }
    }
</style>
<!-- Plugins css Ends-->
{% endblock %}

{% block title %}Club Member List{% endblock %}

{% block content %}
<div class="page-body">
    <div class="container-fluid">
        <div class="page-title">
            <div class="row">
                <!-- Breadcrumb (full width on mobile, 4 cols on desktop) -->
                <div class="col-12 col-md-4 mb-2 mb-md-0">
                    <h3 class="mb-0 text-truncate">{{ breadcrumb.child }}</h3>
                </div>
                <!-- Buttons (full width on mobile, 8 cols on desktop) -->
                <div class="col-12 col-md-8">
                    <div class="d-flex flex-wrap gap-1 justify-content-start justify-content-md-end">
                        {% if request.user|has_permission:'club_member_create' %}
                        <!-- Equal width buttons -->
                            <a class="btn btn-primary flex-grow-1 flex-md-grow-0" style="min-width: 120px;" href="{% url 'club_member_create' %}">
                                <i class="fa fa-plus"></i> Add Member
                            </a>
                        {% endif %}
                        <!-- Equal width buttons -->
                        {% if request.user|has_permission:'club_member_create_bulk' %}
                            <button class="btn btn-success flex-grow-1 flex-md-grow-0" style="min-width: 120px;" data-toggle="modal" data-target="#uploadExcelModal">
                                <i class="fa fa-file-excel-o"></i>  Upload Excel
                            </button>
                            <a href="{% static 'files/club_members_sample.xlsx' %}" class="btn btn-info flex-grow-1 flex-md-grow-0" style="min-width: 120px;" download>
                                <i class="fa fa-download"></i> Sample File
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="display nowrap" id="club-members-table" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>No.</th>
                                        <th>Membership ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded via DataTables -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Club Member Modal -->
<div class="modal fade" id="deleteClubMemberModal" tabindex="-1" aria-labelledby="deleteClubMemberModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteClubMemberModalLabel">Delete Club Member</h5>
                <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" id="deleteClubMemberForm">
                    {% csrf_token %}
                    <input type="hidden" id="club_member_id" name="id">
                    <p>Are you sure you want to delete this club member? A notification email will be sent to them.</p>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Delete Member</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Upload Excel Modal -->
<div class="modal fade" id="uploadExcelModal" tabindex="-1" role="dialog" aria-labelledby="uploadExcelModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg modal-dialog-centered" role="document">
		<form id="uploadExcelForm" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="uploadExcelModalLabel">Upload Club Members via Excel</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<div class="mb-3">
						<div class="alert">
							<i class="fa fa-info-circle"></i>
							<strong>Note:</strong> Accepted format: .xlsx | Required columns: 
                            <code>'Member ID', 'Parent Member ID', 'Name', 'Birthdate', 'Email', 'Phone', 'Address','Reward points', 'Enrollment Date', 'Anniversary Date'</code>
						</div>
					</div>
					<div class="form-group">
						<label for="excel_file">Select Excel File</label>
						<input type="file" class="form-control-file" name="excel_file" id="excel_file" accept=".xlsx">
						<div class="invalid-feedback">Please upload a valid Excel file.</div>
					</div>
					<!-- Error/Success Container -->
					<div id="errorContainer" class="mt-3"></div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-success">
						<i class="fa fa-file-excel-o"></i> Upload & Create Members 
                    </button>
				</div>
			</div>
		</form>
	</div>
</div>
{% endblock %}

{% block scriptcontent %}
<!-- Required JS for Bootstrap -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<!-- DataTables JS -->
<script src="{% static 'assets/js/datatable/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'assets/js/datatable/datatables/datatable.custom.js' %}"></script>
<script src="{% static 'assets/js/tooltip-init.js' %}"></script>

<script>
$(document).ready(function() {
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Helper function to set button loading state
    function setButtonLoading(button, isLoading) {
        if (isLoading) {
            button.prop('disabled', true);
            button.find('.spinner-border').removeClass('d-none');
        } else {
            button.prop('disabled', false);
            button.find('.spinner-border').addClass('d-none');
        }
    }

    // Delete Club Member Modal - Set action URL
    $('#deleteClubMemberModal').on('show.bs.modal', function(event) {
        var button = $(event.relatedTarget);
        var memberId = button.data('id');
        $('#deleteClubMemberForm').attr('action', `/club-members/delete/${memberId}/`);
        $('#club_member_id').val(memberId);
    });

    // Clear form and errors when modal is closed
    $('.modal').on('hidden.bs.modal', function() {
        $(this).find('form')[0].reset();
        $(this).find('.is-invalid').removeClass('is-invalid');
        $(this).find('.invalid-feedback').text('');
        // Clear the error container specifically for upload modal
        if ($(this).attr('id') === 'uploadExcelModal') {
            $('#errorContainer').empty();
        }
    });

    // Initialize DataTable with server-side processing
    var table = $('#club-members-table').DataTable({
        "processing": true,
        "serverSide": true,
        "ajax": {
            "url": window.location.pathname,
            "type": "POST",
            "data": function(d) {
                // Add CSRF token
                d.csrfmiddlewaretoken = getCookie('csrftoken');
            },
            "error": function(xhr, error, code) {
                console.error(xhr, error, code);
                $('#club-members-table').DataTable().clear().draw();
                $('#club-members-table tbody').html(
                    '<tr><td colspan="7" class="text-center text-danger py-4">' +
                    '<i class="fa fa-exclamation-circle mr-2"></i>Error loading data</td></tr>'
                );
            }
        },
        "columns": [
            { 
                "data": "counter",
                "orderable": true 
            },
            { 
                "data": "membership_id",
                "orderable": true 
            },
            { 
                "data": "name",
                "orderable": true 
            },
            { 
                "data": "email",
                "orderable": true 
            },
            { 
                "data": "phone",
                "orderable": true 
            },
            { 
                "data": "status",
                "orderable": false  // This column has HTML content, so disable sorting
            },
            { 
                "data": "actions",
                "orderable": false  // Actions column shouldn't be sorted
            }
        ],
        "responsive": true,
        "lengthMenu": [[10, 25, 50, 100], [10, 25, 50, 100]],
        "pageLength": 10,
        "language": {
            "lengthMenu": "Show _MENU_ entries",
            "zeroRecords": "No matching records found",
            "info": "Showing _START_ to _END_ of _TOTAL_ entries",
            "infoEmpty": "Showing 0 to 0 of 0 entries",
            "infoFiltered": "(filtered from _MAX_ total entries)",
            "search": "Search:",
            "paginate": {
                "first": "First",
                "last": "Last",
                "next": "Next",
                "previous": "Previous"
            }
        },
        "dom": "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
               "<'row'<'col-sm-12'tr>>" +
               "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
        "initComplete": function() {
            // Add custom styling after table initialization
            $('.dataTables_length select').addClass('form-control form-control-sm');
            $('.dataTables_filter input').addClass('form-control form-control-sm');
        }
    });

    // Action menu toggle
    $(document).on('click', '.three-dots-menu', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // Close all other action cards first
        $('.action-card').not($(this).siblings('.action-card')).hide();
        
        // Toggle the current action card
        var actionCard = $(this).siblings('.action-card');
        actionCard.toggle();
    });
    
    // Hide action card if clicking outside
    $(document).on('click', function(event) {
        if (!$(event.target).closest('.action-menu-container').length) {
            $('.action-card').hide();
        }
    });

    // Toggle Member Status
    $(document).on('click', '.toggle-status', function(e) {
        e.preventDefault();
        const memberId = $(this).data('id');
        const statusBtn = $(this);
        statusBtn.prop('disabled', true);
        
        $.ajax({
            url: `/club-members/toggle-status/${memberId}/`,
            type: 'POST',
            data: {
                csrfmiddlewaretoken: getCookie('csrftoken'),
                source_page: 'club_member_list',
                title: 'Club Member'
            },
            success: function(response) {
                if (response.success) {
                    // Instead of showing toast, just reload the page
                    window.location.reload();
                }
            },
            error: function() {
                console.error('An error occurred');
            },
            complete: function() {
                statusBtn.prop('disabled', false);
            }
        });
    });

    // Update the upload form submission handler
    $('#uploadExcelForm').submit(function(e) {
        e.preventDefault();
        const form = $(this);
        const formData = new FormData(this);
        const submitBtn = form.find('button[type="submit"]');
        
        // Clear previous errors
        $('#errorContainer').empty();
        $('.is-invalid').removeClass('is-invalid');
        
        // Show loading state
        submitBtn.prop('disabled', true);
        submitBtn.html('<i class="fa fa-spinner fa-spin"></i> Processing...');
        
        $.ajax({
            url: '/club-members/upload-excel/',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    let resultHtml = '';
                    
                    // Show success message
                    if (response.created_count > 0) {
                        resultHtml += `
                            <div class="alert alert-success">
                             <i class="fa fa-check-circle"></i>
                                ${response.message}
                            </div>
                        `;
                    }
                    
                    // Show warning message if there are errors but some users were created
                    if (response.has_warnings && response.errors && response.errors.length > 0) {
                        resultHtml += `
                            <div class="alert alert-warning">
                                <i class="fa fa-exclamation-triangle"></i>
                                ${response.warning_message}
                            </div>
                        `;
                        
                        // Display detailed errors
                        resultHtml += '<div class="mt-2"><strong>Rows with errors:</strong></div>';
                        resultHtml += '<div class="error-list" style="max-height: 300px; overflow-y: auto;">';
                        
                        response.errors.forEach(error => {
                            resultHtml += `<div class="border rounded p-2 mb-2 bg-light">`;
                            resultHtml += `<div class="font-weight-bold text-warning">Row ${error.row}:</div>`;
                            
                            if (error.errors && Array.isArray(error.errors)) {
                                resultHtml += `<ul class="mb-1">`;
                                error.errors.forEach(err => {
                                    resultHtml += `<li class="text-warning">${err}</li>`;
                                });
                                resultHtml += `</ul>`;
                            }
                            
                            if (error.data && typeof error.data === 'object') {
                                resultHtml += `<div class="small text-muted">`;
                                resultHtml += `<strong>Data:</strong> `;
                                resultHtml += `ID: ${error.data.membership_id || 'N/A'}, `;
                                resultHtml += `Name: ${error.data.name || 'N/A'}, `;
                                resultHtml += `Email: ${error.data.email || 'N/A'}, `;
                                resultHtml += `Phone: ${error.data.phone || 'N/A'}`;
                                resultHtml += `</div>`;
                            }
                            resultHtml += `</div>`;
                        });
                        resultHtml += '</div>';
                    }
                    
                    // Show the result in the modal
                    $('#errorContainer').html(resultHtml);
                    
                    // If all users were created successfully without warnings, close modal and reload
                    if (response.created_count > 0 && !response.has_warnings) {
                        setTimeout(() => {
                            $('#uploadExcelModal').modal('hide');
                            window.location.reload();
                        }, 2000);
                    }
                    // If there were warnings, keep modal open for user to see details
                    
                } else {
                    // Handle complete failure (no users created)
                    let errorHtml = '<div class="alert alert-danger">';
                    
                    if (response.message) {
                        errorHtml += `<h6><i class="fa fa-exclamation-circle"></i> ${response.message}</h6>`;
                    }
                    
                    if (response.errors && Array.isArray(response.errors) && response.errors.length > 0) {
                        errorHtml += '<div class="mt-2"><strong>Validation Errors:</strong></div>';
                        errorHtml += '<div class="error-list" style="max-height: 300px; overflow-y: auto;">';
                        
                        response.errors.forEach(error => {
                            errorHtml += `<div class="border rounded p-2 mb-2 bg-light">`;
                            errorHtml += `<div class="font-weight-bold text-danger">Row ${error.row}:</div>`;
                            
                            if (error.errors && Array.isArray(error.errors)) {
                                errorHtml += `<ul class="mb-1">`;
                                error.errors.forEach(err => {
                                    errorHtml += `<li class="text-danger">${err}</li>`;
                                });
                                errorHtml += `</ul>`;
                            }
                            
                            if (error.data && typeof error.data === 'object') {
                                errorHtml += `<div class="small text-muted">`;
                                errorHtml += `<strong>Data:</strong> `;
                                errorHtml += `ID: ${error.data.membership_id || 'N/A'}, `;
                                errorHtml += `Name: ${error.data.name || 'N/A'}, `;
                                errorHtml += `Email: ${error.data.email || 'N/A'}, `;
                                errorHtml += `Phone: ${error.data.phone || 'N/A'}`;
                                errorHtml += `</div>`;
                            }
                            errorHtml += `</div>`;
                        });
                        errorHtml += '</div>';
                    }
                    
                    errorHtml += '</div>';
                    $('#errorContainer').html(errorHtml);
                }
            },
            error: function(xhr) {
                let errorMessage = 'Error uploading file';
                let errorDetails = null;
                
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.message) {
                        errorMessage = response.message;
                    }
                    if (response.errors) {
                        errorDetails = response.errors;
                    }
                } catch (e) {
                    console.error('Error parsing response:', e);
                }
                
                let errorHtml = `<div class="alert alert-danger">
                    <h6><i class="fa fa-exclamation-circle"></i> ${errorMessage}</h6>`;
                
                if (errorDetails && errorDetails.length > 0) {
                    errorHtml += '<div class="mt-2"><strong>Validation Errors:</strong></div>';
                    errorHtml += '<div class="error-list" style="max-height: 300px; overflow-y: auto;">';
                    
                    errorDetails.forEach(error => {
                        errorHtml += `<div class="border rounded p-2 mb-2 bg-light">`;
                        errorHtml += `<div class="font-weight-bold text-danger">Row ${error.row}:</div>`;
                        
                        if (error.errors && Array.isArray(error.errors)) {
                            errorHtml += `<ul class="mb-1">`;
                            error.errors.forEach(err => {
                                errorHtml += `<li class="text-danger">${err}</li>`;
                            });
                            errorHtml += `</ul>`;
                        }
                        
                        if (error.data && typeof error.data === 'object') {
                            errorHtml += `<div class="small text-muted">`;
                            errorHtml += `<strong>Data:</strong> `;
                            errorHtml += `ID: ${error.data.membership_id || 'N/A'}, `;
                            errorHtml += `Name: ${error.data.name || 'N/A'}, `;
                            errorHtml += `Email: ${error.data.email || 'N/A'}, `;
                            errorHtml += `Phone: ${error.data.phone || 'N/A'}`;
                            errorHtml += `</div>`;
                        }
                        errorHtml += `</div>`;
                    });
                    errorHtml += '</div>';
                }
                
                errorHtml += '</div>';
                $('#errorContainer').html(errorHtml);
            },
            complete: function() {
                submitBtn.prop('disabled', false);
                submitBtn.html('<i class="fa fa-file-excel-o"></i> Upload & Create Members');
            }
        });
    });

    // Add Download Sample button click handler
    $('#downloadSampleBtn').click(function() {
        window.location.href = "{% static 'files/club_members_sample.xlsx' %}";
    });
});
</script>
{% endblock %}