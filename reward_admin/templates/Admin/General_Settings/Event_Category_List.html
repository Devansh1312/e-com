{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}
{% load sass_tags %}

{% block css %}
<!-- Plugins css start-->
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/datatables.scss' %}">
<!-- Add this to your base template's head section -->
<!-- Color Picker CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.css">
<!-- Plugins css Ends-->
<style>
    /* Enhanced Color picker styles */
    .colorpicker .input-group-text {
        cursor: pointer;
        width: 40px;
        justify-content: center;
        border: 1px solid #ced4da;
        border-left: none;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
    }

    .colorpicker .input-group-text:hover {
        background-color: #e9ecef;
        border-color: #adb5bd;
    }

    /* Color picker preview square */
    .colorpicker .fa-square {
        transition: all 0.3s;
        font-size: 18px;
        border: 1px solid #dee2e6;
        border-radius: 2px;
    }

    /* Color input field styling */
    .colorpicker .form-control {
        border-right: none;
        text-transform: uppercase;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-weight: 500;
    }

    .colorpicker .form-control:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    /* Custom color palette */
    .color-palette {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 6px;
        border: 1px solid #dee2e6;
    }

    .color-palette-item {
        width: 30px;
        height: 30px;
        border-radius: 4px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s ease;
        position: relative;
    }

    .color-palette-item:hover {
        transform: scale(1.1);
        border-color: #495057;
    }

    .color-palette-item.selected {
        border-color: #0d6efd;
        transform: scale(1.15);
        box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
    }

    /* Spectrum color picker customization */
    .sp-container {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    .sp-replacer {
        border: 1px solid #ced4da;
        border-radius: 4px;
        background: #fff;
        width: 100%;
        height: 38px;
        padding: 0;
    }

    .sp-preview {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 4px;
    }

    .sp-dd {
        display: none;
    }
</style>
{% endblock %}

{% block title %}
Event Category Management
{% endblock %}

{% block content %}
<div class="page-body">
    <div class="container-fluid">
        <div class="page-title">
            <div class="row">
                <div class="col-12 col-md-6">
                    <h3>{{breadcrumb.child}}</h3>
                </div>
                <div class="col-12 col-md-6">
                    <ol class="breadcrumb">
                        <button class="btn btn-pill btn-outline-primary-2x ml-auto" data-bs-toggle="modal" data-bs-target="#addEventCategoryModal">Add Event Category</button>
                    </ol>
                </div>
            </div>
        </div>
        <div class="row">
            <!-- Event Category List -->
            <div class="col-sm-12">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="display" id="basic-1">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Color</th>
                                        <th>Created At</th>
                                        <th>Updated At</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for category in event_categories %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ category.name }}</td>
                                        <td>
                                            {% if category.ticket_color %}
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <div style="width: 20px; height: 20px; background-color: {{ category.ticket_color }}; border: 1px solid #dee2e6; border-radius: 3px;"></div>
                                                <span class="badge" style="color: black;">
                                                    {{ category.ticket_color }}
                                                </span>
                                            </div>
                                            {% else %}
                                            <span class="badge bg-secondary">Not set</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ category.created_at|date:"Y-m-d H:i" }}</td>
                                        <td>{{ category.updated_at|date:"Y-m-d H:i" }}</td>
                                        <td>
                                            <!-- Update action buttons to include ticket_color -->
                                            <div class="action-menu-container" style="position: relative; display: inline-block;">
                                                <a href="#" class="three-dots-menu" onclick="toggleMenu(this)">
                                                    <i data-feather="more-vertical"></i>
                                                </a>
                                                <div class="action-card" style="display: none; position: absolute; top: 100%; right: 0; background: #fff; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); z-index: 10; width: auto;">
                                                    <ul style="list-style: none; padding: 0; margin: 0;">
                                                        <li style="padding: 8px 12px;">
                                                            <a style="font-size: small;" href="#" data-bs-toggle="modal" data-bs-target="#editEventCategoryModal" 
                                                            data-category-id="{{ category.id }}" 
                                                            data-category-name="{{ category.name }}"
                                                            data-ticket-color="{{ category.ticket_color|default:'#FFFFFF' }}">Edit</a>
                                                        </li>
                                                        <li style="padding: 8px 12px;">
                                                            <a style="font-size: small;" href="#" onclick="confirmDelete('{% url 'event_category_delete' category.id %}')">Delete</a>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Event Category Modal -->
<div class="modal fade" id="addEventCategoryModal" tabindex="-1" aria-labelledby="addEventCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addEventCategoryModalLabel">Add Event Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'event_category_create' %}" id="addEventCategoryForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="name" name="name" placeholder="Enter Category Name">
                            <div class="invalid-feedback" id="name-error"></div>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="ticketColor" class="form-label">Ticket Color</label>
                            <input type="text" class="form-control" id="ticketColor" name="ticket_color" value="#3B82F6">
                            
                            <!-- Color Palette -->
                            <div class="color-palette" id="addColorPalette">
                                <div class="color-palette-item" data-color="#EF4444" style="background-color: #EF4444;" title="Red"></div>
                                <div class="color-palette-item" data-color="#F97316" style="background-color: #F97316;" title="Orange"></div>
                                <div class="color-palette-item" data-color="#EAB308" style="background-color: #EAB308;" title="Yellow"></div>
                                <div class="color-palette-item" data-color="#22C55E" style="background-color: #22C55E;" title="Green"></div>
                                <div class="color-palette-item" data-color="#06B6D4" style="background-color: #06B6D4;" title="Cyan"></div>
                                <div class="color-palette-item selected" data-color="#3B82F6" style="background-color: #3B82F6;" title="Blue"></div>
                                <div class="color-palette-item" data-color="#8B5CF6" style="background-color: #8B5CF6;" title="Purple"></div>
                                <div class="color-palette-item" data-color="#EC4899" style="background-color: #EC4899;" title="Pink"></div>
                                <div class="color-palette-item" data-color="#6B7280" style="background-color: #6B7280;" title="Gray"></div>
                                <div class="color-palette-item" data-color="#1F2937" style="background-color: #1F2937;" title="Dark"></div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Category</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Event Category Modal -->
<div class="modal fade" id="editEventCategoryModal" tabindex="-1" aria-labelledby="editEventCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editEventCategoryModalLabel">Edit Event Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" id="editEventCategoryForm">
                    {% csrf_token %}
                    <div class="row">
                        <input type="hidden" id="editCategoryId" name="id">
                        <div class="col-12 mb-3">
                            <label for="editName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="editName" name="name" placeholder="Enter Category Name">
                            <div class="invalid-feedback" id="edit-name-error"></div>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="editTicketColor" class="form-label">Ticket Color</label>
                            <input type="text" class="form-control" id="editTicketColor" name="ticket_color" value="#3B82F6">
                            
                            <!-- Color Palette -->
                            <div class="color-palette" id="editColorPalette">
                                <div class="color-palette-item" data-color="#EF4444" style="background-color: #EF4444;" title="Red"></div>
                                <div class="color-palette-item" data-color="#F97316" style="background-color: #F97316;" title="Orange"></div>
                                <div class="color-palette-item" data-color="#EAB308" style="background-color: #EAB308;" title="Yellow"></div>
                                <div class="color-palette-item" data-color="#22C55E" style="background-color: #22C55E;" title="Green"></div>
                                <div class="color-palette-item" data-color="#06B6D4" style="background-color: #06B6D4;" title="Cyan"></div>
                                <div class="color-palette-item" data-color="#3B82F6" style="background-color: #3B82F6;" title="Blue"></div>
                                <div class="color-palette-item" data-color="#8B5CF6" style="background-color: #8B5CF6;" title="Purple"></div>
                                <div class="color-palette-item" data-color="#EC4899" style="background-color: #EC4899;" title="Pink"></div>
                                <div class="color-palette-item" data-color="#6B7280" style="background-color: #6B7280;" title="Gray"></div>
                                <div class="color-palette-item" data-color="#1F2937" style="background-color: #1F2937;" title="Dark"></div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Category</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="{% static 'assets/js/datatable/datatables/jquery.dataTables.min.js'%}"></script>
<script src="{% static 'assets/js/datatable/datatables/datatable.custom.js'%}"></script>
<script src="{% static 'assets/js/tooltip-init.js'%}"></script>
<!-- Color Picker JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Edit Event Category Modal
        var editEventCategoryModal = document.getElementById('editEventCategoryModal');
        if (editEventCategoryModal) {
            editEventCategoryModal.addEventListener('show.bs.modal', function(event) {
                var button = event.relatedTarget;
                var categoryId = button.getAttribute('data-category-id');
                var categoryName = button.getAttribute('data-category-name');
                var ticketColor = button.getAttribute('data-ticket-color') || '#3B82F6';

                var form = document.getElementById('editEventCategoryForm');
                form.action = "{% url 'event_category_edit' 0 %}".replace('0', categoryId);

                form.querySelector('#editCategoryId').value = categoryId;
                form.querySelector('#editName').value = categoryName;
                form.querySelector('#editTicketColor').value = ticketColor;
                
                // Update edit color picker
                updateColorPicker('editTicketColor', ticketColor);
                updatePaletteSelection('editColorPalette', ticketColor);
            });
        }
        
        // Initialize color pickers when DOM is loaded
        initColorPickers();
        
        // Toggle the visibility of the action card
        document.querySelectorAll('.three-dots-menu').forEach(function(menu) {
            menu.addEventListener('click', function(event) {
                event.preventDefault();
                var actionCard = menu.nextElementSibling;
                actionCard.style.display = (actionCard.style.display === 'none' || actionCard.style.display === '') ? 'block' : 'none';
                // Close other open action cards
                document.querySelectorAll('.action-card').forEach(function(card) {
                    if (card !== actionCard) {
                        card.style.display = 'none';
                    }
                });
            });
        });

        // Hide action card if clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.action-menu-container')) {
                document.querySelectorAll('.action-card').forEach(function(card) {
                    card.style.display = 'none';
                });
            }
        });

        // Form validation
        function validateForm(form) {
            let isValid = true;
            const nameField = form.querySelector('[name="name"]');
            const nameError = form.querySelector('#name-error') || form.querySelector('#edit-name-error');
            
            // Clear previous errors
            nameField.classList.remove('is-invalid');
            if (nameError) nameError.textContent = '';
            
            // Validate name
            if (!nameField.value.trim()) {
                nameField.classList.add('is-invalid');
                if (nameError) nameError.textContent = 'Category name is required.';
                isValid = false;
            }
            
            return isValid;
        }

        // Add form submission with validation
        document.getElementById('addEventCategoryForm').addEventListener('submit', function(e) {
            if (!validateForm(this)) {
                e.preventDefault();
                const firstInvalid = this.querySelector('.is-invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });

        // Edit form submission with validation
        document.getElementById('editEventCategoryForm').addEventListener('submit', function(e) {
            if (!validateForm(this)) {
                e.preventDefault();
                const firstInvalid = this.querySelector('.is-invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });

        // Real-time validation on input
        document.querySelectorAll('[name="name"]').forEach(field => {
            field.addEventListener('input', function() {
                const errorId = this.id.includes('edit') ? 'edit-name-error' : 'name-error';
                const errorElement = document.getElementById(errorId);
                
                if (this.value.trim()) {
                    this.classList.remove('is-invalid');
                    if (errorElement) errorElement.textContent = '';
                }
            });
        });
    });

    function confirmDelete(url) {
        if (confirm('Are you sure you want to delete this category?')) {
            window.location.href = url;
        }
    }

    // Initialize enhanced color pickers
    function initColorPickers() {
        // Initialize Spectrum color picker for add modal
        $('#ticketColor').spectrum({
            type: "component",
            showInput: true,
            showInitial: true,
            showPalette: false,
            showButtons: true,
            allowEmpty: false,
            preferredFormat: "hex",
            cancelText: "Cancel",
            chooseText: "Select",
            change: function(color) {
                const hexColor = color.toHexString().toUpperCase();
                $('#ticketColor').val(hexColor);
                updatePaletteSelection('addColorPalette', hexColor);
            }
        });

        // Initialize Spectrum color picker for edit modal
        $('#editTicketColor').spectrum({
            type: "component",
            showInput: true,
            showInitial: true,
            showPalette: false,
            showButtons: true,
            allowEmpty: false,
            preferredFormat: "hex",
            cancelText: "Cancel",
            chooseText: "Select",
            change: function(color) {
                const hexColor = color.toHexString().toUpperCase();
                $('#editTicketColor').val(hexColor);
                updatePaletteSelection('editColorPalette', hexColor);
            }
        });

        // Initialize color palette functionality
        initColorPalette('addColorPalette', 'ticketColor');
        initColorPalette('editColorPalette', 'editTicketColor');

        // Manual input validation and formatting
        $('#ticketColor, #editTicketColor').on('input', function() {
            let value = $(this).val();
            if (value && !value.startsWith('#')) {
                value = '#' + value;
            }
            if (isValidHexColor(value)) {
                $(this).val(value.toUpperCase());
                $(this).spectrum('set', value);
                const paletteId = $(this).attr('id') === 'ticketColor' ? 'addColorPalette' : 'editColorPalette';
                updatePaletteSelection(paletteId, value);
            }
        });
    }

    // Initialize color palette functionality
    function initColorPalette(paletteId, inputId) {
        const palette = document.getElementById(paletteId);
        const input = document.getElementById(inputId);
        
        if (palette && input) {
            const colorItems = palette.querySelectorAll('.color-palette-item');
            
            colorItems.forEach(item => {
                item.addEventListener('click', function() {
                    const color = this.getAttribute('data-color');
                    input.value = color;
                    $('#' + inputId).spectrum('set', color);
                    updatePaletteSelection(paletteId, color);
                });
            });
        }
    }

    // Update palette selection
    function updatePaletteSelection(paletteId, selectedColor) {
        const palette = document.getElementById(paletteId);
        if (palette) {
            const colorItems = palette.querySelectorAll('.color-palette-item');
            colorItems.forEach(item => {
                if (item.getAttribute('data-color').toLowerCase() === selectedColor.toLowerCase()) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }
    }

    // Update color picker value
    function updateColorPicker(inputId, color) {
        const input = document.getElementById(inputId);
        if (input) {
            input.value = color;
            $('#' + inputId).spectrum('set', color);
        }
    }

    // Validate hex color
    function isValidHexColor(hex) {
        return /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(hex);
    }

    // Get contrasting text color for better readability
    function getContrastColor(hexColor) {
        // Remove # if present
        hexColor = hexColor.replace('#', '');
        
        // Convert to RGB
        const r = parseInt(hexColor.substr(0, 2), 16);
        const g = parseInt(hexColor.substr(2, 2), 16);
        const b = parseInt(hexColor.substr(4, 2), 16);
        
        // Calculate brightness
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        
        // Return black or white based on brightness
        return brightness > 128 ? '#000000' : '#FFFFFF';
    }
</script>
{% endblock %}