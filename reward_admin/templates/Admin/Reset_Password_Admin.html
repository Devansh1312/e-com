{% extends 'base-other-page.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Reset Password" %}{% endblock %}

{% block content %}
<div class="row m-0">
    <div class="col-12 p-0">    
        <div class="login-card">
            <div>
                <div>
                    <a class="logo" href="{% url 'adminlogin' %}">
                        <img class="img-fluid for-light" style="width: 240px; height: 70px;" src="{{ website_logo }}" alt="loginpage">
                        <img class="img-fluid for-dark" src="{{ website_logo }}" alt="loginpage">
                    </a>
                </div>
                <div class="login-main"> 
                    <form class="theme-form" method="post" id="resetPasswordForm" novalidate>
                        {% csrf_token %}
                        <h4>{% trans "Reset Password" %}</h4>
                        
                        {% if messages %}
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} mb-3">
                                    {{ message }}
                                </div>
                            {% endfor %}
                        {% endif %}

                        <div class="form-group position-relative mb-3">
                            <label class="col-form-label">{% trans "New Password" %}</label>
                            <input type="password" class="form-control" name="password" id="password" 
                                   placeholder="{% trans 'Enter new password' %}" required>
                            <i class="fa fa-eye toggle-password" toggle="#password"></i>
                            <div class="password-strength mt-2">
                                <div class="strength-bar">
                                    <div class="strength-fill" id="strengthBar"></div>
                                </div>
                                <small class="strength-text" id="strengthText">{% trans "Password strength" %}</small>
                            </div>
                            <small class="form-text text-muted">
                                {% trans "Must contain: 8+ characters, uppercase, lowercase, digit, special character" %}
                            </small>
                            <div class="invalid-feedback" id="password-error"></div>
                        </div>
                        
                        <div class="form-group position-relative mb-3">
                            <label class="col-form-label">{% trans "Confirm Password" %}</label>
                            <input type="password" class="form-control" name="confirm_password" id="confirm_password" 
                                   placeholder="{% trans 'Confirm new password' %}" required>
                            <i class="fa fa-eye toggle-password" toggle="#confirm_password"></i>
                            <div class="invalid-feedback" id="confirm-password-error"></div>
                        </div>

                        <div class="form-group mb-0">
                            <div class="text-end mt-3">
                                <button class="btn btn-primary btn-block w-100" type="submit">
                                    {% trans "Reset Password" %}
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-center mt-3">
                            <a href="{% url 'adminlogin' %}" class="text-muted">
                                {% trans "Back to Login" %}
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scriptscontent %}
<!-- Font Awesome for eye icon -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
    .toggle-password {
        position: absolute;
        top: 47px;
        right: 15px;
        cursor: pointer;
        color: #888;
        z-index: 2;
        transition: color 0.3s ease;
    }

    .toggle-password:hover {
        color: #555;
    }

    .password-strength {
        margin-top: 8px;
    }

    .strength-bar {
        width: 100%;
        height: 5px;
        background-color: #e0e0e0;
        border-radius: 3px;
        overflow: hidden;
    }

    .strength-fill {
        height: 100%;
        width: 0%;
        transition: width 0.3s ease, background-color 0.3s ease;
        border-radius: 3px;
    }

    .strength-weak {
        background-color: #ff4757;
        width: 25%;
    }

    .strength-medium {
        background-color: #ffa502;
        width: 60%;
    }

    .strength-strong {
        background-color: #2ed573;
        width: 100%;
    }

    .strength-text {
        font-size: 12px;
        margin-top: 4px;
        display: block;
        font-weight: 500;
    }

    .text-weak {
        color: #ff4757;
    }

    .text-medium {
        color: #ffa502;
    }

    .text-strong {
        color: #2ed573;
    }

    .invalid-feedback {
        display: none;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #dc3545;
    }

    .is-invalid ~ .invalid-feedback {
        display: block;
    }

    .form-control.is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }

    .form-control.is-valid {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }
</style>

<!-- jQuery Validate -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/additional-methods.min.js"></script>

<script>
$(document).ready(function() {
    // Custom validation method for strong password
    $.validator.addMethod("strongPassword", function(value, element) {
        return this.optional(element) || 
            /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/.test(value);
    }, "{% trans 'Password must contain at least one uppercase letter, one lowercase letter, one digit, and one special character' %}");

    // Password strength checker
    function checkPasswordStrength(password) {
        let strength = 0;
        let feedback = {
            text: "{% trans 'Very Weak' %}",
            class: 'text-weak',
            barClass: ''
        };

        // Length check
        if (password.length >= 8) strength += 1;
        if (password.length >= 12) strength += 1;

        // Character variety checks
        if (/[a-z]/.test(password)) strength += 1; // lowercase
        if (/[A-Z]/.test(password)) strength += 1; // uppercase
        if (/[0-9]/.test(password)) strength += 1; // numbers
        if (/[@$!%*?&]/.test(password)) strength += 1; // special characters

        // Determine strength level
        if (strength <= 2) {
            feedback = {
                text: "{% trans 'Weak' %}",
                class: 'text-weak',
                barClass: 'strength-weak'
            };
        } else if (strength <= 4) {
            feedback = {
                text: "{% trans 'Medium' %}",
                class: 'text-medium',
                barClass: 'strength-medium'
            };
        } else if (strength >= 5) {
            feedback = {
                text: "{% trans 'Strong' %}",
                class: 'text-strong',
                barClass: 'strength-strong'
            };
        }

        return feedback;
    }

    // Real-time password strength indicator
    $('#password').on('input', function() {
        const password = $(this).val();
        const strength = checkPasswordStrength(password);
        
        $('#strengthBar').removeClass('strength-weak strength-medium strength-strong')
                        .addClass(strength.barClass);
        $('#strengthText').removeClass('text-weak text-medium text-strong')
                         .addClass(strength.class)
                         .text(strength.text);
    });

    // Form validation
    $("#resetPasswordForm").validate({
        rules: {
            password: {
                required: true,
                minlength: 8,
                strongPassword: true
            },
            confirm_password: {
                required: true,
                minlength: 8,
                equalTo: "#password"
            }
        },
        messages: {
            password: {
                required: "{% trans 'Please enter a password' %}",
                minlength: "{% trans 'Password must be at least 8 characters long' %}",
                strongPassword: "{% trans 'Password must contain at least one uppercase letter, one lowercase letter, one digit, and one special character' %}"
            },
            confirm_password: {
                required: "{% trans 'Please confirm your password' %}",
                minlength: "{% trans 'Password must be at least 8 characters long' %}",
                equalTo: "{% trans 'Passwords do not match' %}"
            }
        },
        errorPlacement: function(error, element) {
            // Place error in custom div instead of after element
            if (element.attr("name") == "password") {
                $("#password-error").html(error.html()).show();
            } else if (element.attr("name") == "confirm_password") {
                $("#confirm-password-error").html(error.html()).show();
            }
        },
        highlight: function(element, errorClass, validClass) {
            $(element).removeClass(validClass).addClass('is-invalid');
        },
        unhighlight: function(element, errorClass, validClass) {
            $(element).removeClass('is-invalid');
            // Remove the is-valid class to prevent green border
            $(element).removeClass('is-valid');
            // Hide error message when field becomes valid
            if (element.name == "password") {
                $("#password-error").hide();
            } else if (element.name == "confirm_password") {
                $("#confirm-password-error").hide();
            }
        },
        success: function(label, element) {
            // Hide error message on success
            if (element.name == "password") {
                $("#password-error").hide();
            } else if (element.name == "confirm_password") {
                $("#confirm-password-error").hide();
            }
        }
    });

    // Toggle Password Visibility
    $(".toggle-password").click(function() {
        let input = $($(this).attr("toggle"));
        if (input.attr("type") === "password") {
            input.attr("type", "text");
            $(this).removeClass("fa-eye").addClass("fa-eye-slash");
        } else {
            input.attr("type", "password");
            $(this).removeClass("fa-eye-slash").addClass("fa-eye");
        }
    });

    // Real-time password match validation
    $('#confirm_password').on('input', function() {
        if ($(this).val() !== '' && $(this).val() !== $('#password').val()) {
            $(this).addClass('is-invalid').removeClass('is-valid');
            $('#confirm-password-error').html("{% trans 'Passwords do not match' %}").show();
        } else if ($(this).val() === $('#password').val() && $(this).val() !== '') {
            $(this).removeClass('is-invalid');
            // Remove the is-valid class to prevent green border
            $(this).removeClass('is-valid');
            $('#confirm-password-error').hide();
        }
    });

    // Clear validation states on form reset
    $('#resetPasswordForm')[0].addEventListener('reset', function() {
        $('.form-control').removeClass('is-valid is-invalid');
        $('.invalid-feedback').hide();
        $('#strengthBar').removeClass('strength-weak strength-medium strength-strong');
        $('#strengthText').removeClass('text-weak text-medium text-strong').text("{% trans 'Password strength' %}");
    });
});
</script>
{% endblock %}